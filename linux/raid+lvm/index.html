<!DOCTYPE html>
<!--[if lt IE 7 ]> <html class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Raid+lvm - KnowTo</title>
      
      
      
        <link rel="canonical" href="https://thej.github.io/know-to/linux/raid+lvm/">
      
      
        <meta name="author" content="Jochen Greif">
      
    
    <meta property="og:url" content="https://thej.github.io/know-to/linux/raid+lvm/">
    <meta property="og:title" content="KnowTo">
    <meta property="og:image" content="https://thej.github.io/know-to/linux/raid+lvm//../../None">
    <meta name="apple-mobile-web-app-title" content="KnowTo">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <link rel="icon" type="image/x-icon" href="../../assets/images/favicon-e565ddfa3b.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../../assets/fonts/icon.eot?52m981');
      	src: url('../../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../../assets/stylesheets/application-e576885f03.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
    <script src="../../assets/javascripts/modernizr-2216498cab.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
      
      
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Linux <i class="icon icon-link"></i>
              
            
          </span>
        
        Raid+lvm
      </div>
    </div>
    
      
      <div class="button button-twitter" role="button" aria-label="Twitter">
        <a href="https://twitter.com/squirroloo" title="@squirroloo on Twitter" target="_blank" class="toggle-button icon icon-twitter"></a>
      </div>
    
    
      
      <div class="button button-github" role="button" aria-label="GitHub">
        <a href="https://github.com/thej" title="@thej on GitHub" target="_blank" class="toggle-button icon icon-github"></a>
      </div>
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false">
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="https://github.com/thej/know-to" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          KnowTo
          <span class="version">
            0.1.0
          </span>
        </strong>
        
          <br>
          thej/know-to
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
        <ul class="repo">
          <li class="repo-download">
            
              
              <a href="https://github.com/thej/know-to/releases/tag/0.1.0" target="_blank" title="Download" data-action="download">
                <i class="icon icon-download"></i> Download
              </a>
            
          </li>
          <li class="repo-stars">
            <a href="https://github.com/thej/know-to/stargazers" target="_blank" title="Stargazers" data-action="star">
              <i class="icon icon-star"></i> Stars
              <span class="count">&ndash;</span>
            </a>
          </li>
        </ul>
        <hr>
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="../..">
      Home
    </a>
    
  </li>

          
            
  <li>
    <a class="" title="Security of networked cars" href="../../security_of_networked_cars/">
      Security of networked cars
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Homeserver</span>
    <ul>
      
        
  <li>
    <a class="" title="Haproxy" href="../../homeserver/haproxy/">
      Haproxy
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Homeserver" href="../../homeserver/homeserver/">
      Homeserver
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Network plan" href="../../homeserver/network_plan/">
      Network plan
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Samba" href="../../homeserver/samba/">
      Samba
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Linux</span>
    <ul>
      
        
  <li>
    <a class="" title="Arch post install" href="../arch_post_install/">
      Arch post install
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Compile arch kernel" href="../compile_arch_kernel/">
      Compile arch kernel
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Docker" href="../docker/">
      Docker
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Encrypt system ssd" href="../encrypt_system_ssd/">
      Encrypt system ssd
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Install ubuntu touch on nexus 5" href="../install_ubuntu_touch_on_nexus_5/">
      Install ubuntu touch on nexus 5
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Iptables" href="../iptables/">
      Iptables
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Linux on dell xps 13" href="../linux_on_dell_xps_13/">
      Linux on dell xps 13
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Lxc" href="../lxc/">
      Lxc
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Pure nexus rom on nexus 5" href="../pure_nexus_rom_on_nexus_5/">
      Pure nexus rom on nexus 5
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Raid+lvm" href="./">
      Raid+lvm
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Partitioning" href="#partitioning">
                Partitioning
              </a>
            </li>
          
            <li class="anchor">
              <a title="Encryption" href="#encryption">
                Encryption
              </a>
            </li>
          
            <li class="anchor">
              <a title="LVM" href="#lvm">
                LVM
              </a>
            </li>
          
            <li class="anchor">
              <a title="Update RAID configuration" href="#update-raid-configuration">
                Update RAID configuration
              </a>
            </li>
          
            <li class="anchor">
              <a title="crypttap and fstab" href="#crypttap-and-fstab">
                crypttap and fstab
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
        
  <li>
    <a class="" title="Raspberry pi" href="../raspberry_pi/">
      Raspberry pi
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Sync configs with mackup" href="../sync_configs_with_mackup/">
      Sync configs with mackup
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Ubuntu touch on nexus 5" href="../ubuntu_touch_on_nexus_5/">
      Ubuntu touch on nexus 5
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Management</span>
    <ul>
      
        
  <li>
    <a class="" title="Time management" href="../../management/time_management/">
      Time management
    </a>
    
  </li>

      
    </ul>
  </li>

          
            
  <li>
    <span class="section">Rails</span>
    <ul>
      
        
  <li>
    <a class="" title="Snippet flash messages" href="../../rails/snippet_flash_messages/">
      Snippet flash messages
    </a>
    
  </li>

      
    </ul>
  </li>

          
        </ul>
        
          <hr>
          <span class="section">The author</span>
          <ul>
            
              
              <li>
                <a href="https://twitter.com/squirroloo" target="_blank" title="@squirroloo on Twitter">
                  @squirroloo on Twitter
                </a>
              </li>
            
            
              
              <li>
                <a href="https://github.com/thej" target="_blank" title="@thej on GitHub">
                  @thej on GitHub
                </a>
              </li>
            
          </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="raid-lvm-encryption">RAID + LVM + Encryption<a class="headerlink" href="#raid-lvm-encryption" title="Permanent link">#</a></h1>
<ul>
<li>2 identical HDs (/dev/hdb and /dev/hdc)</li>
</ul>
<h2 id="partitioning">Partitioning<a class="headerlink" href="#partitioning" title="Permanent link">#</a></h2>
<h3 id="preparing-first-hd">Preparing first HD<a class="headerlink" href="#preparing-first-hd" title="Permanent link">#</a></h3>
<pre class="code"><code>gdisk /dev/sdb
# create partition with type fd00 (Raid)
# write and exit</code></pre>


<h3 id="clone-partition-table-to-devsdc">Clone partition table to /dev/sdc<a class="headerlink" href="#clone-partition-table-to-devsdc" title="Permanent link">#</a></h3>
<p>Clone partitions with <em>sgdisk</em>:</p>
<pre class="code"><code>sgdisk --backup=table /dev/sdb
sgdisk --load-backup=table /dev/sdc</code></pre>


<h3 id="create-raid-array">Create RAID array<a class="headerlink" href="#create-raid-array" title="Permanent link">#</a></h3>
<p><code>mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/sd[bc]1</code></p>
<h2 id="encryption">Encryption<a class="headerlink" href="#encryption" title="Permanent link">#</a></h2>
<pre class="code"><code>cryptsetup luksFormat -c aes-xts-plain64 -s 512 /dev/md0
cryptsetup luksOpen /dev/md0 cryptdisk</code></pre>


<h2 id="lvm">LVM<a class="headerlink" href="#lvm" title="Permanent link">#</a></h2>
<p>The three next steps create, in this order, the physical volume (the container, if you will), the group and then the individual volumes contained in the group. Choose simple, memorable names and do not hypenate them. The {pv,vg,lv}display commands print out the details of the devices once created.</p>
<pre class="code"><code>pvcreate /dev/mapper/cryptdisk
pvdisplay

vgcreate vgraid /dev/mapper/cryptdisk
vgdisplay

lvcreate -l +100%FREE  vgraid -n data</code></pre>


<h3 id="format-volume">Format volume<a class="headerlink" href="#format-volume" title="Permanent link">#</a></h3>
<p><code>mkfs.ext4 -L data -m 0 /dev/vgraid/data</code></p>
<h3 id="get-5-space-from-data-volume">Get 5% space from data volume<a class="headerlink" href="#get-5-space-from-data-volume" title="Permanent link">#</a></h3>
<p>5% space are by default hidden on ext4 partitions. This is typically used on root partition as a safeguard when the disk gets full. On non-root partition this hidden space can be easily and safely reclaimed back by using the following command.</p>
<p><code>tune2fs -m 0 /dev/mapper/data</code></p>
<h2 id="update-raid-configuration">Update RAID configuration<a class="headerlink" href="#update-raid-configuration" title="Permanent link">#</a></h2>
<p>Since the installer builds the initrd using /etc/mdadm.conf in the target system, you should update that file with your RAID configuration. The original file can simply be deleted because it contains comments on how to fill it correctly, and that is something mdadm can do automatically for you. So let us delete the original and have mdadm create you a new one with the current setup:</p>
<p><code>mdadm --examine --scan &gt;&gt; /etc/mdadm.conf</code></p>
<h2 id="crypttap-and-fstab">crypttap and fstab<a class="headerlink" href="#crypttap-and-fstab" title="Permanent link">#</a></h2>
<p>Generate a keyfile:
<code>dd bs=512 count=4 if=/dev/urandom of=/etc/keyfile_cryptdisk iflag=fullblock</code></p>
<p>Add keyfile to key slot:
<code>cryptsetup luksAddKey /dev/md0 /etc/keyfile_cryptdisk</code></p>
<p>Add <em>/etc/crypttab</em> entry: </p>
<pre class="code"><code>cryptdisk       /dev/md0                /etc/keyfile_cryptdisk</code></pre>


<p>Add <em>/etc/fstab</em> entry</p>
<pre class="code"><code>/dev/vgraid/data        /data           ext4            defaults,relatime       0 1</code></pre>
          <aside class="copyright" role="note">
            
              Copyright (c) 2016 Jochen Greif &ndash;
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../pure_nexus_rom_on_nexus_5/" title="Pure nexus rom on nexus 5">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Pure nexus rom on nexus 5
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
        <a href="../raspberry_pi/" title="Raspberry pi">
          <span class="direction">
            Next
          </span>
          <div class="page">
            <div class="stretch">
              <div class="title">
                Raspberry pi
              </div>
            </div>
            <div class="button button-next" role="button" aria-label="Next">
              <i class="icon icon-forward"></i>
            </div>
          </div>
        </a>
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '../..';
      var repo_id  = 'thej/know-to';
    </script>
    <script src="../../assets/javascripts/application-d10e0693ea.js"></script>
    
    
  </body>
</html>